name: Custom Client Build

on:
  workflow_dispatch:
    inputs:
      config_ids:
        description: 'Comma-separated list of configuration IDs to build'
        required: false
        type: string
  push:
    branches:
      - main
    paths:
      - 'client/**'
      - 'librechat-config/custom-styles/**'

jobs:
  determine-configs:
    runs-on: ubuntu-latest
    outputs:
      config-matrix: ${{ steps.set-matrix.outputs.config-matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: aproorg/librechat-config
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Determine configurations
        id: set-matrix
        run: |
          if [ -n "${{ github.event.inputs.config_ids }}" ]; then
            # Use manually specified configurations
            CONFIGS=$(echo "${{ github.event.inputs.config_ids }}" | tr ',' '\n' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            # Discover configurations from directory structure
            CONFIGS=$(find custom-styles -mindepth 1 -maxdepth 1 -type d | sed 's|custom-styles/||' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi
          echo "config-matrix=${CONFIGS}" >> $GITHUB_OUTPUT

  build-client:
    needs: determine-configs
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config_id: ${{ fromJson(needs.determine-configs.outputs.config-matrix) }}
    steps:
      - name: Checkout LibreChat
        uses: actions/checkout@v4
        with:
          repository: aproorg/LibreChat
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Checkout librechat-config
        uses: actions/checkout@v4
        with:
          repository: aproorg/librechat-config
          token: ${{ secrets.GITHUB_TOKEN }}
          path: librechat-config
          
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build client with custom styling
        env:
          LIBRECHAT_CONFIG_PATH: './librechat-config'
        run: |
          cd client
          npm ci
          node ./scripts/custom-styling/custom-styling.mjs ${{ matrix.config_id }}
          
      - name: Upload client build
        uses: actions/upload-artifact@v4
        with:
          name: librechat-client-${{ matrix.config_id }}
          path: client/dist
          retention-days: 7
